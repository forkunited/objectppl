// Run with:
// webppl test/wppl/game/train_Ld.wppl --require gameppl --require webppl-nn --require . --random-seed 1 --iterations 100

var args = parseArgs();
var rootDir = args["rootDir"];
var iterations = args["iterations"]*1;
var latentDim = args["latentDim"]*1;
var batchSize = 100;
var gradientSamples = 1;

var inputF = gameppl.feature.loadFeatureMatrix(rootDir + "/examples/features/mat/Ld_in");
var outputF = gameppl.feature.loadFeatureMatrix(rootDir + "/examples/features/mat/Ld_out");

var D = makeDataFromFeatureMatrices(inputF, outputF, { inputType : DATA_TYPE_SEQUENCE, outputType : DATA_TYPE_SCALAR });

var D_split = splitDataOnKey(D, 0.9, "game");
var D_train = D_split[0];
var D_test = D_split[1];

var parameterPrior = function() {
    return {
        latentDimension: latentDim,//gameppl.feature.getFeatureMatrixVocabularySize(inputF),//(inputF)/4,
        outputDimension : 3, // 3 possible image locations
        decoderType : DECODER_SOFTMAX,
    }
};

var makeModel = function(params) {
    var m = makeSequenceInputModel(params);
    return function(input) {
        var outputVec = m(input);
        var cats = _.range(3);
        return Categorical({ps: outputVec, vs: cats});
    }
};

var obj = makeTrainingObj(makeModel, parameterPrior,
    {   inputType: DATA_TYPE_SEQUENCE,
        outputType: DATA_TYPE_SCALAR,
        batchSize: batchSize,
        modelObserves : false
    });

display("Training on " + D.length + " examples of size " + gameppl.feature.getFeatureMatrixVocabularySize(inputF));

var results = train(obj, D_train, iterations, gradientSamples);

var trainedModel = results[0];

var classify = function(d) {
    var outDist = trainedModel(d.input);
    var maxIndex = gameppl.util.argmax(outDist.params.ps)[0];
    return outDist.params.vs[maxIndex];
};

var Y_hat_train = map(classify, D_train);
var Y_train = map(function(d) { return d.output; }, D_train);
var Y_hat_test = map(classify, D_test);
var Y_test = map(function(d) { return d.output; }, D_test);

var trainAcc = gameppl.evaluation.sampleAccuracy(Y_hat_train, Y_train, false);
var testAcc = gameppl.evaluation.sampleAccuracy(Y_hat_test, Y_test, false);
var trainLL = evaluationModelLL(trainedModel, D_train);
var testLL = evaluationModelLL(trainedModel, D_test);

display("iterations\ttrainAcc\ttestAcc\ttrainLL\ttestLL");
display(iterations + "\t" + trainAcc + "\t" + testAcc  +"\t" + trainLL + "\t" + testLL);
